---
title: "DESeq2"
output: html_document
---

```{r setup, include=FALSE}
require("knitr")
knitr::opts_chunk$set(echo = TRUE)
opts_knit$set(root.dir = "C:\\GitHub\\dnFGFR\\deseq_outputs\\")
library(dplyr)
library(DESeq2)
library(knitr)
library(ggplot2)
ALLOW_WGCNA_THREADS=8
```

#Load counts and sample info
```{r}
counts = read.table("allSamplesFixed.txt", header=TRUE, row.names=1, sep="\t")
coldata = read.table("coldataAllSamplesFixed.txt", header=TRUE, sep="\t")
```

#remove length from counts table
```{r}
#counts['Length'] = NULL
```

# Filter data to show different cohorts

```{r}
require(dplyr)
PN140counts <- select(counts, contains("B"))
PN140coldata <- filter(coldata, time=="PN140")
PN140DNcounts <- select(PN140counts, contains("B2"))
PN140DNcoldata <- filter(PN140coldata, genotype =="dnFGFR")
```

#sort coldata so it matches counts table columns
```{r}
coldata_sort <-coldata[order(coldata$sample),]
```


#make deseq2 object
```{r}
dds = DESeqDataSetFromMatrix(countData = PN140DNcounts, colData = PN140DNcoldata, design= ~housing)
```

#transform counts for PCA plots
```{r}
rld <- rlog(dds, blind=FALSE)
vst <- vst(dds, blind=FALSE)
ntd <- normTransform(dds)
```

#plot SD of transformed data
```{r}
setwd("C:\\GitHub\\dnFGFR\\deseq_outputs\\pdfs\\")
library("vsn")
pdf("sdplot_shiftedLogtransformed.pdf")
meanSdPlot(assay(ntd))
dev.off()

pdf("sdplot_regLogtransformed.pdf")
meanSdPlot(assay(rld))
dev.off()

pdf("sdplot_varstabilizedtransformed.pdf")
meanSdPlot(assay(vst))
dev.off()
```

#check to see what is the dominant driver of gene expression differences
```{r}
setwd("C:\\GitHub\\dnFGFR\\deseq_outputs\\pdfs\\")
pdf("allsamples_genotype_PCA.pdf")
sampleDists <- dist(t(assay(vst)))
plotPCA(rld, intgroup=c("genotype"))
dev.off()

pdf("allsamples_treatment_PCA.pdf")
sampleDists <- dist(t(assay(vst)))
plotPCA(rld, intgroup=c("housing"))
dev.off()

pdf("allsamples_day_PCA.pdf")
sampleDists <- dist(t(assay(vst)))
plotPCA(rld, intgroup=c("time"))
dev.off()
```

# PN140 effect of housing on dnFGFR animals
```{r}
#Designate Files
setwd("C:\\GitHub\\dnFGFR\\deseq_outputs\\PN140\\dn_housing\\")

dds = DESeqDataSetFromMatrix(countData = PN140DNcounts, colData = PN140DNcoldata, design = ~ housing)

#remove low count genes (anything less than 20 reads)
keep <- rowSums(counts(dds)) >= 20
dds <- dds[keep,]

#set comparison level, 
dds$housing <- relevel(dds$housing, ref = "same")

#perform normalization, dispersion estimate, and statistical tests
dds = DESeq(dds)

#plot dispersions
pdf("dn_housing_dispersionPlot.pdf")
plotDispEsts(dds )
dev.off()

#write out normalized counts
normed = counts(dds, normalized=TRUE)
write.csv(normed, file="dn_PN140_normCounts.csv")

#write out statistical results
res <- results(dds)
write.csv(as.data.frame(res), file="dn_PN140_housing_results.csv")

#plot fold changes with 2 fold blue line added, alpha is FDR cutoff, change to whatever cutoff you want
pdf("dn_PN140_housing_MAPlot.pdf")
DESeq2::plotMA(res, alpha = 0.1, ylim=c(-3,3), cex=.4)
abline(h=c(-1,1), col="dodgerblue", lwd=2)
dev.off()

```

# PN140 effect of housing at PN140
```{r}
#Designate Files
setwd("C:\\GitHub\\dnFGFR\\deseq_outputs\\PN140\\housing\\")

dds = DESeqDataSetFromMatrix(countData = PN140counts, colData = PN140coldata, design = ~ housing)

#remove low count genes (anything less than 20 reads)
keep <- rowSums(counts(dds)) >= 20
dds <- dds[keep,]

#set comparison level, 
dds$housing <- relevel(dds$housing, ref = "same")
dds$genotype <- relevel(dds$genotype, ref = "ctrl")

#perform normalization, dispersion estimate, and statistical tests
dds = DESeq(dds)

#plot dispersions
pdf("housing_dispersionPlot.pdf")
plotDispEsts(dds )
dev.off()

#write out normalized counts
normed = counts(dds, normalized=TRUE)
write.csv(normed, file="PN140_normCounts.csv")

#write out statistical results
res <- results(dds)
write.csv(as.data.frame(res), file="PN140_housing_results.csv")

#plot fold changes with 2 fold blue line added, alpha is FDR cutoff, change to whatever cutoff you want
pdf("PN140_housing_MAPlot.pdf")
DESeq2::plotMA(res, alpha = 0.1, ylim=c(-3,3), cex=.4)
abline(h=c(-1,1), col="dodgerblue", lwd=2)
dev.off()

```


# PCA FIXED All samples, effect of housing controlling for genotype and time
```{r}
#Designate Files
setwd("/Users/gallifrey/Desktop/dnFGFR/allsamplesfixed/deseq2/genotype/")

counts1 = read.table("allSamplesFixed.txt", header=TRUE, row.names=1, sep="\t")
coldata = read.table("coldataAllSamplesFixed.txt", header=TRUE, sep="\t")

#remove length column
counts1['Length'] = NULL

#set dds object, define design
dds = DESeqDataSetFromMatrix(countData = counts1, colData = coldata, design = ~ housing + time + genotype)

#remove low count genes (anything less than 20 reads)
keep <- rowSums(counts(dds)) >= 20
dds <- dds[keep,]

#set comparison level, 
dds$housing <- relevel(dds$housing, ref = "same")
dds$genotype <- relevel(dds$genotype, ref = "ctrl")

#perform normalization, dispersion estimate, and statistical tests
dds = DESeq(dds)

#plot dispersions
pdf("all_fixed_dispersionPlot.pdf")
plotDispEsts(dds )
dev.off()

#write out normalized counts
normed = counts(dds, normalized=TRUE)
write.csv(normed, file="all_fixed_genotype_normCounts.csv")

#write out statistical results
res <- results(dds)
write.csv(as.data.frame(res), file="all_fixed_genotype_results.csv")

#plot fold changes with 2 fold blue line added, alpha is FDR cutoff, change to whatever cutoff you want
pdf("all_fixed_genotype_MAPlot.pdf")
DESeq2::plotMA(res, alpha = 0.1, ylim=c(-3,3), cex=.4)
abline(h=c(-1,1), col="dodgerblue", lwd=2)
dev.off()

```



# PCA FIXED All samples, effect of interaction term housing*time
```{r}
#Designate Files
setwd("/Users/gallifrey/Desktop/dnFGFR/allsamplesfixed/deseq2/interaction/")

counts1 = read.table("allSamplesFixed.txt", header=TRUE, row.names=1, sep="\t")
coldata = read.table("coldataAllSamplesFixed.txt", header=TRUE, sep="\t")

#remove length column
counts1['Length'] = NULL

#set dds object, define design
dds = DESeqDataSetFromMatrix(countData = counts1, colData = coldata, design = ~ housing + time + genotype + housing:genotype)

#remove low count genes (anything less than 20 reads)
keep <- rowSums(counts(dds)) >= 20
dds <- dds[keep,]

#set comparison level, 
dds$housing <- relevel(dds$housing, ref = "same")
dds$genotype <- relevel(dds$genotype, ref = "ctrl")

#perform normalization, dispersion estimate, and statistical tests
dds = DESeq(dds)

#plot dispersions
pdf("all_fixed_dispersionPlot.pdf")
plotDispEsts(dds )
dev.off()

#write out normalized counts
normed = counts(dds, normalized=TRUE)
write.csv(normed, file="all_fixed_interaction_normCounts.csv")

#write out statistical results
res <- results(dds)
write.csv(as.data.frame(res), file="all_fixed_interaction_results.csv")

#plot fold changes with 2 fold blue line added, alpha is FDR cutoff, change to whatever cutoff you want
pdf("all_fixed_interaction_MAPlot.pdf")
DESeq2::plotMA(res, alpha = 0.1, ylim=c(-3,3), cex=.4)
abline(h=c(-1,1), col="dodgerblue", lwd=2)
dev.off()

```




# PN140 dnFGFR effect of housing
```{r}
setwd("/Users/gallifrey/Desktop/dnFGFR/PN140 dnFGFR/")
#Designate Files
counts1 = read.table("PN140dnFGFRcounts.txt", header=TRUE, row.names=1, sep="\t")
coldata = read.table("PN140dnFGFRcoldata.txt", header=TRUE, row.names=1, sep="\t")

#remove length column
counts1['Length'] = NULL

#set dds object, define design
dds = DESeqDataSetFromMatrix(countData = counts1, colData = coldata, design = ~housing)

#remove low count genes (anything less than 20 reads)
keep <- rowSums(counts(dds)) >= 20
dds <- dds[keep,]

#set comparison level, 
dds$housing <- relevel(dds$housing, ref = "same")

#perform normalization, dispersion estimate, and statistical tests
dds = DESeq(dds)

#plot dispersions
pdf("PN140dnFGFRdispersionPlot.pdf")
plotDispEsts(dds )
dev.off()

#write out normalized counts
normed = counts(dds, normalized=TRUE)
write.csv(normed, file="PN140dnFGFRNormCounts.csv")

#write out statistical results
res <- results(dds)
write.csv(as.data.frame(res), file="PN140dnFGFR_results.csv")

#plot fold changes with 2 fold blue line added, alpha is FDR cutoff, change to whatever cutoff you want
pdf("PN140dnFGFR_MAPlot.pdf")
DESeq2::plotMA(res, alpha = 0.1, ylim=c(-3,3), cex=.4)
abline(h=c(-1,1), col="dodgerblue", lwd=2)
dev.off()

```

# PN140 Control effect of housing
```{r}
setwd("/Users/gallifrey/Desktop/dnFGFR/PN140 control/")
#Designate Files
counts1 = read.table("PN140control_counts.txt", header=TRUE, row.names=1, sep="\t")
coldata = read.table("PN140control_coldata.txt", header=TRUE, row.names=1, sep="\t")

#remove length column
counts1['Length'] = NULL

#set dds object, define design
dds = DESeqDataSetFromMatrix(countData = counts1, colData = coldata, design = ~housing)

#remove low count genes (anything less than 20 reads)
keep <- rowSums(counts(dds)) >= 20
dds <- dds[keep,]

#set comparison level, 
dds$housing <- relevel(dds$housing, ref = "same")

#perform normalization, dispersion estimate, and statistical tests
dds = DESeq(dds)

#plot dispersions
pdf("PN140control_dispersionPlot.pdf")
plotDispEsts(dds )
dev.off()

#write out normalized counts
normed = counts(dds, normalized=TRUE)
write.csv(normed, file="PN140controlNormCounts.csv")

#write out statistical results
res <- results(dds)
write.csv(as.data.frame(res), file="PN140control_results.csv")

#plot fold changes with 2 fold blue line added, alpha is FDR cutoff, change to whatever cutoff you want
pdf("PN140control_MAPlot.pdf")
DESeq2::plotMA(res, alpha = 0.1, ylim=c(-3,3), cex=.4)
abline(h=c(-1,1), col="dodgerblue", lwd=2)
dev.off()

```

#Comparing effect of housing in 40D animals controlling for genotype
```{r}
#Designate Files
counts1 = read.table("40D_counts.txt", header=TRUE, row.names=1, sep="\t")
coldata = read.table("40D_coldata.txt", header=TRUE, sep="\t")

#remove length column
counts1['Length'] = NULL

#remove low count genes (anything less than 20 reads)
keep <- rowSums(counts(dds)) >= 20
dds <- dds[keep,]

#set dds object, define design
dds = DESeqDataSetFromMatrix(countData = counts1, colData = coldata, design = ~genotype + housing)

#set comparison level, 
dds$housing <- relevel(dds$housing, ref = "same")

#perform normalization, dispersion estimate, and statistical tests
dds = DESeq(dds)

#plot dispersions
pdf("40D_dispersionPlot.pdf")
plotDispEsts(dds )
dev.off()

#write out normalized counts
normed = counts(dds, normalized=TRUE)
write.csv(normed, file="40D_normCounts.csv")

#write out statistical results
res <- results(dds)
write.csv(as.data.frame(res), file="40D_results.csv")

#plot fold changes with 2 fold blue line added, alpha is FDR cutoff, change to whatever cutoff you want
pdf("40D_MAPlot.pdf")
DESeq2::plotMA(res, alpha = 0.1, ylim=c(-3,3), cex=.4)
abline(h=c(-1,1), col="dodgerblue", lwd=2)
dev.off()

```

#Comparing effect of housing in 120D animals controlling for genotype
```{r}
#Designate Files
counts2 = read.table("120D_counts.txt", header=TRUE, row.names=1, sep="\t")
coldata = read.table("120D_coldata.txt", header=TRUE, sep="\t")

#remove length column
counts2['Length'] = NULL

#remove low count genes (anything less than 20 reads)
keep <- rowSums(counts(dds)) >= 20
dds <- dds[keep,]

#set dds object, define design
dds = DESeqDataSetFromMatrix(countData = counts2, colData = coldata, design = ~genotype + housing)

#set comparison level, 
dds$housing <- relevel(dds$housing, ref = "same")

#perform normalization, dispersion estimate, and statistical tests
dds = DESeq(dds)

#plot dispersions
pdf("120D_dispersionPlot.pdf")
plotDispEsts(dds )
dev.off()

#write out normalized counts
normed = counts(dds, normalized=TRUE)
write.csv(normed, file="120D_normCounts.csv")

#write out statistical results
res <- results(dds)
write.csv(as.data.frame(res), file="120D_results.csv")

#plot fold changes with 2 fold blue line added, alpha is FDR cutoff, change to whatever cutoff you want
pdf("120D_MAPlot.pdf")
DESeq2::plotMA(res, alpha = 0.1, ylim=c(-3,3), cex=.4)
abline(h=c(-1,1), col="dodgerblue", lwd=2)
dev.off()

```


#Comparing effect of genotype on 40D animals while controlling for housing
```{r}
#Designate Files
counts1 = read.table("40D_counts.txt", header=TRUE, row.names=1, sep="\t")
coldata = read.table("40D_coldata.txt", header=TRUE, sep="\t")

#remove length column
counts1['Length'] = NULL

#set dds object, define design
dds = DESeqDataSetFromMatrix(countData = counts1, colData = coldata, design = ~housing + genotype)

#set comparison level, 
#dds$housing <- relevel(dds$housing, ref = "same")

dds$genotype <- relevel(dds$genotype, ref = "ctrl")

#perform normalization, dispersion estimate, and statistical tests
dds = DESeq(dds)

#plot dispersions
pdf("40D_dispersionPlot.pdf")
plotDispEsts(dds )
dev.off()

#write out normalized counts
normed = counts(dds, normalized=TRUE)
write.csv(normed, file="40D_normCounts.csv")

#write out statistical results
res <- results(dds)
write.csv(as.data.frame(res), file="40D_results.csv")

#plot fold changes with 2 fold blue line added, alpha is FDR cutoff, change to whatever cutoff you want
pdf("40D_MAPlot.pdf")
DESeq2::plotMA(res, alpha = 0.1, ylim=c(-3,3), cex=.4)
abline(h=c(-1,1), col="dodgerblue", lwd=2)
dev.off()

```


#Comparing effect of genotype on 120D animals while controlling for housing
```{r}
#Designate Files
counts2 = read.table("120D_counts.txt", header=TRUE, row.names=1, sep="\t")
coldata = read.table("120D_coldata.txt", header=TRUE, sep="\t")

#remove length column
counts2['Length'] = NULL

#remove low count genes (anything less than 20 reads)

#set dds object, define design
dds = DESeqDataSetFromMatrix(countData = counts2, colData = coldata, design = ~ housing + genotype)

#set comparison level, 
dds$genotype <- relevel(dds$genotype, ref = "ctrl")

#perform normalization, dispersion estimate, and statistical tests
dds = DESeq(dds)

#plot dispersions
pdf("120D_dispersionPlot.pdf")
plotDispEsts(dds )
dev.off()

#write out normalized counts
normed = counts(dds, normalized=TRUE)
write.csv(normed, file="120D_normCounts.csv")

#write out statistical results
res <- results(dds)
write.csv(as.data.frame(res), file="120D_results.csv")

#plot fold changes with 2 fold blue line added, alpha is FDR cutoff, change to whatever cutoff you want
pdf("120D_MAPlot.pdf")
DESeq2::plotMA(res, alpha = 0.1, ylim=c(-3,3), cex=.4)
abline(h=c(-1,1), col="dodgerblue", lwd=2)
dev.off()

```


# All samples, effect of genotype controlling for housing and time
```{r}
#Designate Files
setwd("/Users/gallifrey/Desktop/dnFGFR/allsamples/deseq2/genotype/")

counts1 = read.table("all_counts.txt", header=TRUE, row.names=1, sep="\t")
coldata = read.table("all_coldata.txt", header=TRUE, sep="\t")

#remove length column
counts1['Length'] = NULL

#set dds object, define design
dds = DESeqDataSetFromMatrix(countData = counts1, colData = coldata, design = ~ housing + time + genotype)

#remove low count genes (anything less than 20 reads)
keep <- rowSums(counts(dds)) >= 20
dds <- dds[keep,]

#set comparison level, 
dds$housing <- relevel(dds$housing, ref = "same")
dds$genotype <- relevel(dds$genotype, ref = "ctrl")

#perform normalization, dispersion estimate, and statistical tests
dds = DESeq(dds)

#plot dispersions
pdf("all_dispersionPlot.pdf")
plotDispEsts(dds )
dev.off()

#write out normalized counts
normed = counts(dds, normalized=TRUE)
write.csv(normed, file="all_genotype_normCounts.csv")

#write out statistical results
res <- results(dds)
write.csv(as.data.frame(res), file="all_genotype_results.csv")

#plot fold changes with 2 fold blue line added, alpha is FDR cutoff, change to whatever cutoff you want
pdf("all_genotype_MAPlot.pdf")
DESeq2::plotMA(res, alpha = 0.1, ylim=c(-3,3), cex=.4)
abline(h=c(-1,1), col="dodgerblue", lwd=2)
dev.off()

```


# All samples, effect of housing controlling for genotype and time
```{r}
#Designate Files
setwd("/Users/gallifrey/Desktop/dnFGFR/allsamples/deseq2/housing/")

counts1 = read.table("all_counts.txt", header=TRUE, row.names=1, sep="\t")
coldata = read.table("all_coldata.txt", header=TRUE, sep="\t")

#remove length column
counts1['Length'] = NULL

#set dds object, define design
dds = DESeqDataSetFromMatrix(countData = counts1, colData = coldata, design = ~ genotype + time + housing)

#remove low count genes (anything less than 20 reads)
keep <- rowSums(counts(dds)) >= 20
dds <- dds[keep,]

#set comparison level, 
dds$housing <- relevel(dds$housing, ref = "same")
dds$genotype <- relevel(dds$genotype, ref = "ctrl")

#perform normalization, dispersion estimate, and statistical tests
dds = DESeq(dds)

#plot dispersions
pdf("all_housing_dispersionPlot.pdf")
plotDispEsts(dds )
dev.off()

#write out normalized counts
normed = counts(dds, normalized=TRUE)
write.csv(normed, file="all_housing_normCounts.csv")

#write out statistical results
res <- results(dds)
write.csv(as.data.frame(res), file="all_housing_results.csv")

#plot fold changes with 2 fold blue line added, alpha is FDR cutoff, change to whatever cutoff you want
pdf("all_housing_MAPlot.pdf")
DESeq2::plotMA(res, alpha = 0.1, ylim=c(-3,3), cex=.4)
abline(h=c(-1,1), col="dodgerblue", lwd=2)
dev.off()

```


# ----------------------------------------------------------------------

#Example of basic comparison of OppSex vs SameSex in 40D control mice. - From Patrick
```{r}
#read in files
counts1 = read.table("control_40D_counts.txt", header=TRUE, row.names=1, sep="\t")
coldata = read.table("control_40D_coldata.txt", header=TRUE, sep="\t")

#remove length column
counts1['Length'] = NULL

#remove low count genes
keep <- rowSums(counts(dds)) >= 20
dds <- dds[keep,]


#set dds object, define design
dds = DESeqDataSetFromMatrix(countData = counts1, colData = coldata, design = ~housing)


#set comparison level, 
dds$housing <- relevel(dds$housing, ref = "sameSex")

#perform normalization, dispersion estimate, and statistical tests
dds = DESeq(dds)

#plot dispersions
pdf("control_40D_dispersionPlot.pdf")
plotDispEsts(dds )
dev.off()

#write out normalized counts
normed = counts(dds, normalized=TRUE)
write.csv(normed, file="control_40D_normCounts.csv")

#write out statistical results
res <- results(dds)
write.csv(as.data.frame(res), file="control_40D_results.csv")

#plot fold changes with 2 fold blue line added, alpha is FDR cutoff, change to whatever cutoff you want
pdf("control_40D_MAPlot.pdf")
DESeq2::plotMA(res, alpha = 0.1, ylim=c(-3,3), cex=.4)
abline(h=c(-1,1), col="dodgerblue", lwd=2)
dev.off()


```



